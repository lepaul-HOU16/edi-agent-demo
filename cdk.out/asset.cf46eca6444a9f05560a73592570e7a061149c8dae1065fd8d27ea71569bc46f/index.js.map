{
  "version": 3,
  "sources": ["../../../lambda-functions/api-s3-proxy/index.ts", "../../../lambda-functions/api-s3-proxy/handler.ts"],
  "sourcesContent": ["export { handler } from './handler';\n", "/**\n * S3 Proxy API Lambda Handler\n * Handles /api/s3-proxy route\n */\n\nimport { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\nimport { \n  S3Client, \n  PutObjectCommand, \n  GetObjectCommand, \n  ListObjectsV2Command,\n  DeleteObjectCommand \n} from '@aws-sdk/client-s3';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\n\nconst s3Client = new S3Client({ region: process.env.AWS_REGION || 'us-east-1' });\n\n/**\n * Parse multipart form data from API Gateway event\n */\nfunction parseMultipartFormData(body: string, contentType: string): Map<string, any> {\n  const boundary = contentType.split('boundary=')[1];\n  if (!boundary) {\n    throw new Error('No boundary found in Content-Type');\n  }\n\n  const parts = body.split(`--${boundary}`);\n  const formData = new Map<string, any>();\n\n  for (const part of parts) {\n    if (part.includes('Content-Disposition')) {\n      const nameMatch = part.match(/name=\"([^\"]+)\"/);\n      if (nameMatch) {\n        const name = nameMatch[1];\n        const contentStart = part.indexOf('\\r\\n\\r\\n') + 4;\n        const contentEnd = part.lastIndexOf('\\r\\n');\n        const value = part.substring(contentStart, contentEnd);\n        \n        if (name === 'file') {\n          // For file data, we need to handle it as binary\n          formData.set(name, value);\n        } else {\n          formData.set(name, value);\n        }\n      }\n    }\n  }\n\n  return formData;\n}\n\nexport const handler = async (\n  event: APIGatewayProxyEventV2\n): Promise<APIGatewayProxyResultV2> => {\n  console.log(`[S3 Proxy API] ${event.requestContext.http.method} ${event.requestContext.http.path}`);\n\n  const bucketName = process.env.STORAGE_BUCKET_NAME;\n  \n  if (!bucketName) {\n    return {\n      statusCode: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        error: 'S3 bucket not configured',\n      }),\n    };\n  }\n\n  try {\n    const method = event.requestContext.http.method;\n\n    // Handle GET request - return signed URL for file or list files\n    if (method === 'GET') {\n      const queryParams = event.queryStringParameters || {};\n      const key = queryParams.key;\n      const action = queryParams.action;\n\n      if (!key) {\n        return {\n          statusCode: 400,\n          headers: {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n          },\n          body: JSON.stringify({\n            error: 'Missing required parameter: key',\n          }),\n        };\n      }\n\n      // Handle list action\n      if (action === 'list') {\n        const subpathStrategy = queryParams.subpathStrategy || 'include';\n        \n        const command = new ListObjectsV2Command({\n          Bucket: bucketName,\n          Prefix: key,\n          Delimiter: subpathStrategy === 'exclude' ? '/' : undefined,\n        });\n\n        const response = await s3Client.send(command);\n        \n        const items = (response.Contents || []).map(item => ({\n          path: item.Key || '',\n          eTag: item.ETag,\n          lastModified: item.LastModified,\n          size: item.Size,\n        }));\n\n        const excludedSubpaths = subpathStrategy === 'exclude' \n          ? (response.CommonPrefixes || []).map(prefix => prefix.Prefix || '')\n          : [];\n\n        return {\n          statusCode: 200,\n          headers: {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n          },\n          body: JSON.stringify({\n            items,\n            excludedSubpaths,\n          }),\n        };\n      }\n\n      // Generate a signed URL that expires in 1 hour\n      const command = new GetObjectCommand({\n        Bucket: bucketName,\n        Key: key,\n      });\n\n      const signedUrl = await getSignedUrl(s3Client, command, { expiresIn: 3600 });\n\n      return {\n        statusCode: 200,\n        headers: {\n          'Content-Type': 'application/json',\n          'Access-Control-Allow-Origin': '*',\n        },\n        body: JSON.stringify({\n          url: signedUrl,\n          key,\n          bucket: bucketName,\n        }),\n      };\n    }\n\n    // Handle POST request - upload file\n    if (method === 'POST') {\n      const contentType = event.headers['content-type'] || '';\n      \n      if (!contentType.includes('multipart/form-data')) {\n        return {\n          statusCode: 400,\n          headers: {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n          },\n          body: JSON.stringify({\n            error: 'Content-Type must be multipart/form-data',\n          }),\n        };\n      }\n\n      const body = event.isBase64Encoded \n        ? Buffer.from(event.body || '', 'base64').toString('utf-8')\n        : event.body || '';\n\n      const formData = parseMultipartFormData(body, contentType);\n      const key = formData.get('key');\n      const fileData = formData.get('file');\n      const fileContentType = formData.get('contentType') || 'application/octet-stream';\n\n      if (!key || !fileData) {\n        return {\n          statusCode: 400,\n          headers: {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n          },\n          body: JSON.stringify({\n            error: 'Missing required fields: key and file',\n          }),\n        };\n      }\n\n      // Upload to S3\n      const command = new PutObjectCommand({\n        Bucket: bucketName,\n        Key: key,\n        Body: Buffer.from(fileData, 'utf-8'),\n        ContentType: fileContentType,\n      });\n\n      await s3Client.send(command);\n\n      return {\n        statusCode: 200,\n        headers: {\n          'Content-Type': 'application/json',\n          'Access-Control-Allow-Origin': '*',\n        },\n        body: JSON.stringify({\n          success: true,\n          key,\n          bucket: bucketName,\n        }),\n      };\n    }\n\n    // Handle DELETE request - delete file\n    if (method === 'DELETE') {\n      const queryParams = event.queryStringParameters || {};\n      const key = queryParams.key;\n\n      if (!key) {\n        return {\n          statusCode: 400,\n          headers: {\n            'Content-Type': 'application/json',\n            'Access-Control-Allow-Origin': '*',\n          },\n          body: JSON.stringify({\n            error: 'Missing required parameter: key',\n          }),\n        };\n      }\n\n      const command = new DeleteObjectCommand({\n        Bucket: bucketName,\n        Key: key,\n      });\n\n      await s3Client.send(command);\n\n      return {\n        statusCode: 200,\n        headers: {\n          'Content-Type': 'application/json',\n          'Access-Control-Allow-Origin': '*',\n        },\n        body: JSON.stringify({\n          success: true,\n          key,\n          bucket: bucketName,\n        }),\n      };\n    }\n\n    // Method not allowed\n    return {\n      statusCode: 405,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        error: 'Method not allowed',\n      }),\n    };\n  } catch (error) {\n    console.error('[S3 Proxy API] Error:', error);\n    return {\n      statusCode: 500,\n      headers: {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      },\n      body: JSON.stringify({\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n      }),\n    };\n  }\n};\n"],
  "mappings": "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",
  "names": ["command"]
}
