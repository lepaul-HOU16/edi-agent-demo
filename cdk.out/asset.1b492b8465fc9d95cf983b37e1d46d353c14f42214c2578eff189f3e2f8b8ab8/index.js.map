{
  "version": 3,
  "sources": ["../../../lambda-functions/osdu/handler.ts"],
  "sourcesContent": ["import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\n\ninterface OSDUSearchRequest {\n  query: string;\n  dataPartition?: string;\n  maxResults?: number;\n}\n\ninterface OSDUSearchResponse {\n  answer: string;\n  recordCount: number;\n  records: Array<any>;\n}\n\nexport const handler = async (\n  event: APIGatewayProxyEventV2\n): Promise<APIGatewayProxyResultV2> => {\n  console.log('\uD83D\uDD0D OSDU REST API Handler:', JSON.stringify(event, null, 2));\n  \n  const path = event.requestContext.http.path;\n  const method = event.requestContext.http.method;\n  \n  try {\n    // POST /api/osdu/search\n    if (path === '/api/osdu/search' && method === 'POST') {\n      const body = JSON.parse(event.body || '{}');\n      const { query, dataPartition = 'osdu', maxResults = 1000 } = body as OSDUSearchRequest;\n      \n      console.log('\uD83D\uDD0D OSDU Search:', { query, dataPartition, maxResults });\n      \n      // Validate inputs\n      if (!query || query.trim().length === 0) {\n        return {\n          statusCode: 400,\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            error: 'Query parameter is required',\n            answer: 'Please provide a search query.',\n            recordCount: 0,\n            records: []\n          }),\n        };\n      }\n      \n      if (maxResults < 1 || maxResults > 10000) {\n        return {\n          statusCode: 400,\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            error: 'maxResults must be between 1 and 10000',\n            answer: 'Invalid search parameters.',\n            recordCount: 0,\n            records: []\n          }),\n        };\n      }\n      \n      // Get API configuration\n      const apiUrl = process.env.OSDU_API_URL;\n      const apiKey = process.env.OSDU_API_KEY;\n      \n      if (!apiUrl || !apiKey) {\n        console.error('\u274C OSDU API configuration missing');\n        return {\n          statusCode: 503,\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            error: 'OSDU API is not configured',\n            answer: 'The OSDU search service is not currently available.',\n            recordCount: 0,\n            records: []\n          }),\n        };\n      }\n      \n      // Call OSDU API\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 50000);\n      \n      let response;\n      try {\n        response = await fetch(apiUrl, {\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n            'x-api-key': apiKey\n          },\n          body: JSON.stringify({\n            query,\n            dataPartition,\n            maxResults\n          }),\n          signal: controller.signal\n        });\n      } catch (fetchError: any) {\n        clearTimeout(timeoutId);\n        \n        if (fetchError.name === 'AbortError') {\n          return {\n            statusCode: 504,\n            headers: { 'Content-Type': 'application/json' },\n            body: JSON.stringify({\n              error: 'Request timeout',\n              answer: 'The OSDU search request timed out.',\n              recordCount: 0,\n              records: []\n            }),\n          };\n        }\n        \n        return {\n          statusCode: 502,\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            error: 'Network error',\n            answer: 'Unable to reach OSDU service.',\n            recordCount: 0,\n            records: []\n          }),\n        };\n      }\n      \n      clearTimeout(timeoutId);\n      \n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error('\u274C OSDU API error:', response.status, errorText);\n        \n        return {\n          statusCode: response.status,\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            error: `OSDU API request failed: ${response.status}`,\n            answer: 'Unable to search OSDU data at this time.',\n            recordCount: 0,\n            records: []\n          }),\n        };\n      }\n      \n      // Parse response\n      let rawData: any;\n      try {\n        rawData = await response.json();\n      } catch (parseError) {\n        return {\n          statusCode: 502,\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            error: 'Invalid response from OSDU API',\n            answer: 'Received invalid data from OSDU service.',\n            recordCount: 0,\n            records: []\n          }),\n        };\n      }\n      \n      // Transform response\n      let answer = rawData.response || rawData.answer || 'Search completed';\n      let recordCount = 0;\n      let records: any[] = [];\n      \n      // Extract records from reasoningSteps\n      if (rawData.reasoningSteps && Array.isArray(rawData.reasoningSteps)) {\n        for (const step of rawData.reasoningSteps) {\n          if (step.type === 'tool_result' && step.result?.body?.records) {\n            records = step.result.body.records;\n            recordCount = step.result.body.metadata?.totalFound || \n                         step.result.body.metadata?.returned || \n                         records.length;\n            break;\n          }\n        }\n      }\n      \n      // Fallback to top-level records\n      if (records.length === 0 && rawData.records) {\n        records = rawData.records;\n        recordCount = rawData.recordCount || records.length;\n      }\n      \n      const result: OSDUSearchResponse = {\n        answer,\n        recordCount,\n        records\n      };\n      \n      console.log('\u2705 OSDU search successful:', { recordCount, recordsLength: records.length });\n      \n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(result),\n      };\n    }\n    \n    // GET /api/osdu/wells/{id}\n    if (path.startsWith('/api/osdu/wells/') && method === 'GET') {\n      const wellId = path.split('/').pop();\n      console.log('\uD83D\uDD0D Get OSDU well:', wellId);\n      \n      // This would call OSDU API to get specific well data\n      // For now, return a placeholder\n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          id: wellId,\n          message: 'Well detail endpoint - to be implemented'\n        }),\n      };\n    }\n    \n    return {\n      statusCode: 404,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ error: 'Not found' }),\n    };\n    \n  } catch (error) {\n    console.error('\u274C OSDU API error:', error);\n    \n    // Sanitize error message\n    let sanitizedMessage = 'An unexpected error occurred';\n    if (error instanceof Error) {\n      sanitizedMessage = error.message\n        .replace(/[a-zA-Z0-9]{40,}/g, '[REDACTED]')\n        .replace(/https?:\\/\\/[^\\s]+/g, '[URL]')\n        .replace(/\\b\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\b/g, '[IP]');\n    }\n    \n    return {\n      statusCode: 500,\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        error: sanitizedMessage,\n        answer: 'An unexpected error occurred while searching OSDU data.',\n        recordCount: 0,\n        records: []\n      }),\n    };\n  }\n};\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAcO,IAAM,UAAU,OACrB,UACqC;AACrC,UAAQ,IAAI,oCAA6B,KAAK,UAAU,OAAO,MAAM,CAAC,CAAC;AAEvE,QAAM,OAAO,MAAM,eAAe,KAAK;AACvC,QAAM,SAAS,MAAM,eAAe,KAAK;AAEzC,MAAI;AAEF,QAAI,SAAS,sBAAsB,WAAW,QAAQ;AACpD,YAAM,OAAO,KAAK,MAAM,MAAM,QAAQ,IAAI;AAC1C,YAAM,EAAE,OAAO,gBAAgB,QAAQ,aAAa,IAAK,IAAI;AAE7D,cAAQ,IAAI,0BAAmB,EAAE,OAAO,eAAe,WAAW,CAAC;AAGnE,UAAI,CAAC,SAAS,MAAM,KAAK,EAAE,WAAW,GAAG;AACvC,eAAO;AAAA,UACL,YAAY;AAAA,UACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,UAC9C,MAAM,KAAK,UAAU;AAAA,YACnB,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,SAAS,CAAC;AAAA,UACZ,CAAC;AAAA,QACH;AAAA,MACF;AAEA,UAAI,aAAa,KAAK,aAAa,KAAO;AACxC,eAAO;AAAA,UACL,YAAY;AAAA,UACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,UAC9C,MAAM,KAAK,UAAU;AAAA,YACnB,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,SAAS,CAAC;AAAA,UACZ,CAAC;AAAA,QACH;AAAA,MACF;AAGA,YAAM,SAAS,QAAQ,IAAI;AAC3B,YAAM,SAAS,QAAQ,IAAI;AAE3B,UAAI,CAAC,UAAU,CAAC,QAAQ;AACtB,gBAAQ,MAAM,uCAAkC;AAChD,eAAO;AAAA,UACL,YAAY;AAAA,UACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,UAC9C,MAAM,KAAK,UAAU;AAAA,YACnB,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,SAAS,CAAC;AAAA,UACZ,CAAC;AAAA,QACH;AAAA,MACF;AAGA,YAAM,aAAa,IAAI,gBAAgB;AACvC,YAAM,YAAY,WAAW,MAAM,WAAW,MAAM,GAAG,GAAK;AAE5D,UAAI;AACJ,UAAI;AACF,mBAAW,MAAM,MAAM,QAAQ;AAAA,UAC7B,QAAQ;AAAA,UACR,SAAS;AAAA,YACP,gBAAgB;AAAA,YAChB,aAAa;AAAA,UACf;AAAA,UACA,MAAM,KAAK,UAAU;AAAA,YACnB;AAAA,YACA;AAAA,YACA;AAAA,UACF,CAAC;AAAA,UACD,QAAQ,WAAW;AAAA,QACrB,CAAC;AAAA,MACH,SAAS,YAAiB;AACxB,qBAAa,SAAS;AAEtB,YAAI,WAAW,SAAS,cAAc;AACpC,iBAAO;AAAA,YACL,YAAY;AAAA,YACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,YAC9C,MAAM,KAAK,UAAU;AAAA,cACnB,OAAO;AAAA,cACP,QAAQ;AAAA,cACR,aAAa;AAAA,cACb,SAAS,CAAC;AAAA,YACZ,CAAC;AAAA,UACH;AAAA,QACF;AAEA,eAAO;AAAA,UACL,YAAY;AAAA,UACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,UAC9C,MAAM,KAAK,UAAU;AAAA,YACnB,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,SAAS,CAAC;AAAA,UACZ,CAAC;AAAA,QACH;AAAA,MACF;AAEA,mBAAa,SAAS;AAEtB,UAAI,CAAC,SAAS,IAAI;AAChB,cAAM,YAAY,MAAM,SAAS,KAAK;AACtC,gBAAQ,MAAM,0BAAqB,SAAS,QAAQ,SAAS;AAE7D,eAAO;AAAA,UACL,YAAY,SAAS;AAAA,UACrB,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,UAC9C,MAAM,KAAK,UAAU;AAAA,YACnB,OAAO,4BAA4B,SAAS,MAAM;AAAA,YAClD,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,SAAS,CAAC;AAAA,UACZ,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI;AACJ,UAAI;AACF,kBAAU,MAAM,SAAS,KAAK;AAAA,MAChC,SAAS,YAAY;AACnB,eAAO;AAAA,UACL,YAAY;AAAA,UACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,UAC9C,MAAM,KAAK,UAAU;AAAA,YACnB,OAAO;AAAA,YACP,QAAQ;AAAA,YACR,aAAa;AAAA,YACb,SAAS,CAAC;AAAA,UACZ,CAAC;AAAA,QACH;AAAA,MACF;AAGA,UAAI,SAAS,QAAQ,YAAY,QAAQ,UAAU;AACnD,UAAI,cAAc;AAClB,UAAI,UAAiB,CAAC;AAGtB,UAAI,QAAQ,kBAAkB,MAAM,QAAQ,QAAQ,cAAc,GAAG;AACnE,mBAAW,QAAQ,QAAQ,gBAAgB;AACzC,cAAI,KAAK,SAAS,iBAAiB,KAAK,QAAQ,MAAM,SAAS;AAC7D,sBAAU,KAAK,OAAO,KAAK;AAC3B,0BAAc,KAAK,OAAO,KAAK,UAAU,cAC5B,KAAK,OAAO,KAAK,UAAU,YAC3B,QAAQ;AACrB;AAAA,UACF;AAAA,QACF;AAAA,MACF;AAGA,UAAI,QAAQ,WAAW,KAAK,QAAQ,SAAS;AAC3C,kBAAU,QAAQ;AAClB,sBAAc,QAAQ,eAAe,QAAQ;AAAA,MAC/C;AAEA,YAAM,SAA6B;AAAA,QACjC;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAEA,cAAQ,IAAI,kCAA6B,EAAE,aAAa,eAAe,QAAQ,OAAO,CAAC;AAEvF,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAC9C,MAAM,KAAK,UAAU,MAAM;AAAA,MAC7B;AAAA,IACF;AAGA,QAAI,KAAK,WAAW,kBAAkB,KAAK,WAAW,OAAO;AAC3D,YAAM,SAAS,KAAK,MAAM,GAAG,EAAE,IAAI;AACnC,cAAQ,IAAI,4BAAqB,MAAM;AAIvC,aAAO;AAAA,QACL,YAAY;AAAA,QACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,QAC9C,MAAM,KAAK,UAAU;AAAA,UACnB,IAAI;AAAA,UACJ,SAAS;AAAA,QACX,CAAC;AAAA,MACH;AAAA,IACF;AAEA,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU,EAAE,OAAO,YAAY,CAAC;AAAA,IAC7C;AAAA,EAEF,SAAS,OAAO;AACd,YAAQ,MAAM,0BAAqB,KAAK;AAGxC,QAAI,mBAAmB;AACvB,QAAI,iBAAiB,OAAO;AAC1B,yBAAmB,MAAM,QACtB,QAAQ,qBAAqB,YAAY,EACzC,QAAQ,sBAAsB,OAAO,EACrC,QAAQ,2CAA2C,MAAM;AAAA,IAC9D;AAEA,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU;AAAA,QACnB,OAAO;AAAA,QACP,QAAQ;AAAA,QACR,aAAa;AAAA,QACb,SAAS,CAAC;AAAA,MACZ,CAAC;AAAA,IACH;AAAA,EACF;AACF;",
  "names": []
}
