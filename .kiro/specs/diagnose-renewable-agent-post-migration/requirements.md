# Requirements Document

## Introduction

The renewable energy agent is not functioning correctly after the CDK migration. Users report that:
1. The first prompt sent does not appear in the chat interface
2. The response is a generic "No response generated" message
3. No artifacts are being displayed

This spec will diagnose the complete flow from frontend to backend and identify all broken integration points.

## Glossary

- **Renewable Agent**: The AI agent responsible for renewable energy analysis workflows
- **Orchestrator**: The Lambda function that coordinates renewable energy tool invocations
- **Proxy Agent**: The TypeScript wrapper that bridges the chat system with the renewable orchestrator
- **Artifacts**: Visual components (maps, charts, reports) generated by the renewable tools
- **CDK Migration**: The transition from Amplify Gen 2 to pure CDK infrastructure

## Requirements

### Requirement 1: Message Display

**User Story:** As a user, I want to see my renewable energy query appear in the chat interface immediately after sending it, so that I know my message was received.

#### Acceptance Criteria

1. WHEN a user sends a renewable energy query, THE Chat Interface SHALL display the user message immediately
2. WHEN the message is sent, THE Chat Interface SHALL show a loading indicator
3. WHEN the backend processes the message, THE Chat Interface SHALL update with the AI response
4. THE Chat Interface SHALL NOT show "No response generated" for valid renewable queries
5. THE Chat Interface SHALL display all artifacts returned by the renewable orchestrator

### Requirement 2: Agent Routing

**User Story:** As a developer, I want renewable energy queries to be correctly routed to the renewable agent, so that they are processed by the appropriate backend service.

#### Acceptance Criteria

1. WHEN a user selects the renewable agent, THE Agent Router SHALL route queries to the RenewableProxyAgent
2. WHEN the agent type is 'auto', THE Agent Router SHALL detect renewable energy patterns and route accordingly
3. THE Agent Router SHALL log the routing decision for debugging
4. THE Agent Router SHALL NOT route renewable queries to the general knowledge agent
5. THE RenewableProxyAgent SHALL be initialized and available at startup

### Requirement 3: Orchestrator Integration

**User Story:** As a developer, I want the renewable proxy agent to successfully invoke the orchestrator Lambda, so that renewable energy analysis can be performed.

#### Acceptance Criteria

1. WHEN the RenewableProxyAgent processes a query, THE Proxy Agent SHALL invoke the orchestrator Lambda synchronously
2. THE Orchestrator Lambda SHALL receive the query, sessionId, and userId
3. THE Orchestrator Lambda SHALL return artifacts and thought steps
4. THE Proxy Agent SHALL transform orchestrator artifacts to EDI format
5. THE Proxy Agent SHALL handle orchestrator errors gracefully

### Requirement 4: Message Persistence

**User Story:** As a user, I want my renewable energy conversations to be saved, so that I can review them later.

#### Acceptance Criteria

1. WHEN a user sends a message, THE Chat Lambda SHALL save the user message to DynamoDB
2. WHEN the orchestrator returns results, THE Chat Lambda SHALL save the AI response with artifacts to DynamoDB
3. THE Chat Lambda SHALL NOT create duplicate messages
4. THE Chat Lambda SHALL include artifacts in the saved AI message
5. THE Chat Lambda SHALL set responseComplete to true for completed messages

### Requirement 5: API Response Format

**User Story:** As a frontend developer, I want the chat API to return a consistent response format, so that the UI can display results correctly.

#### Acceptance Criteria

1. THE Chat API SHALL return a response with success, message, and response fields
2. THE response.text field SHALL contain the AI message text
3. THE response.artifacts field SHALL contain all artifacts from the orchestrator
4. THE Chat API SHALL return HTTP 200 for successful requests
5. THE Chat API SHALL return appropriate error codes for failures

### Requirement 6: Petrophysics Agent Verification

**User Story:** As a developer, I want to verify that the petrophysics agent still works after migration, so that I can isolate renewable-specific issues.

#### Acceptance Criteria

1. WHEN a user sends a petrophysics query, THE Agent Router SHALL route to the petrophysics agent
2. THE Petrophysics Agent SHALL process queries successfully
3. THE Petrophysics Agent SHALL return artifacts and thought steps
4. THE Chat Interface SHALL display petrophysics results correctly
5. THE Petrophysics Agent SHALL NOT be affected by renewable agent issues

### Requirement 7: Error Handling

**User Story:** As a user, I want clear error messages when something goes wrong, so that I understand what happened and how to fix it.

#### Acceptance Criteria

1. WHEN the orchestrator fails, THE Proxy Agent SHALL return a user-friendly error message
2. WHEN Lambda invocation fails, THE Proxy Agent SHALL log detailed error information
3. WHEN artifacts are missing, THE Chat Interface SHALL display the text response
4. THE Error Messages SHALL include actionable remediation steps
5. THE Error Messages SHALL NOT expose internal implementation details

### Requirement 8: Logging and Debugging

**User Story:** As a developer, I want comprehensive logging throughout the renewable agent flow, so that I can diagnose issues quickly.

#### Acceptance Criteria

1. THE Chat Lambda SHALL log all incoming requests with message text and sessionId
2. THE Agent Router SHALL log routing decisions with matched patterns
3. THE Proxy Agent SHALL log orchestrator invocations and responses
4. THE Orchestrator SHALL log intent detection and tool invocations
5. ALL Lambdas SHALL log errors with full stack traces
