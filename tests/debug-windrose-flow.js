#!/usr/bin/env node

/**
 * Debug Wind Rose Data Flow
 * Tests the complete flow from backend ‚Üí orchestrator ‚Üí frontend
 */

const { LambdaClient, InvokeCommand } = require('@aws-sdk/client-lambda');

async function debugWindRoseFlow() {
  console.log('üîç Debugging Wind Rose Data Flow\n');
  
  const lambda = new LambdaClient({ region: process.env.AWS_REGION || 'us-east-1' });
  
  // Step 1: Find the simulation Lambda
  console.log('Step 1: Finding simulation Lambda...');
  const simulationFunctionName = process.env.RENEWABLE_SIMULATION_TOOL_FUNCTION_NAME;
  
  if (!simulationFunctionName) {
    console.error('‚ùå RENEWABLE_SIMULATION_TOOL_FUNCTION_NAME not set');
    console.log('\nRun this from sandbox environment or set environment variables');
    process.exit(1);
  }
  
  console.log(`‚úÖ Found: ${simulationFunctionName}\n`);
  
  // Step 2: Call simulation Lambda directly
  console.log('Step 2: Calling simulation Lambda directly...');
  const simulationPayload = {
    action: 'wind_rose_analysis',
    latitude: 35.067482,
    longitude: -101.395466,
    projectId: 'debug-test-project'
  };
  
  try {
    const simulationCommand = new InvokeCommand({
      FunctionName: simulationFunctionName,
      Payload: JSON.stringify(simulationPayload)
    });
    
    const simulationResponse = await lambda.send(simulationCommand);
    const simulationResult = JSON.parse(Buffer.from(simulationResponse.Payload).toString());
    
    console.log('‚úÖ Simulation Lambda Response:');
    console.log(`   - Success: ${simulationResult.success}`);
    console.log(`   - Type: ${simulationResult.type}`);
    
    if (simulationResult.data) {
      console.log(`   - Has windRoseData: ${!!simulationResult.data.windRoseData}`);
      console.log(`   - Has windStatistics: ${!!simulationResult.data.windStatistics}`);
      console.log(`   - Has plotlyWindRose: ${!!simulationResult.data.plotlyWindRose}`);
      console.log(`   - Has visualizations: ${!!simulationResult.data.visualizations}`);
      
      if (simulationResult.data.plotlyWindRose) {
        console.log('\n   üìä Plotly Wind Rose Data:');
        console.log(`      - Data traces: ${simulationResult.data.plotlyWindRose.data?.length || 0}`);
        console.log(`      - Has layout: ${!!simulationResult.data.plotlyWindRose.layout}`);
        console.log(`      - Has statistics: ${!!simulationResult.data.plotlyWindRose.statistics}`);
      } else {
        console.log('\n   ‚ö†Ô∏è  NO PLOTLY WIND ROSE DATA IN RESPONSE');
      }
      
      if (simulationResult.data.visualizations) {
        console.log('\n   üñºÔ∏è  Visualizations:');
        console.log(`      - wind_rose: ${simulationResult.data.visualizations.wind_rose || 'NOT SET'}`);
      }
    }
    
    // Step 3: Check what orchestrator would receive
    console.log('\n\nStep 3: Checking orchestrator mapping...');
    console.log('The orchestrator should map this to:');
    console.log('   artifact.data.plotlyWindRose = result.data.plotlyWindRose');
    console.log('   artifact.data.visualizationUrl = result.data.visualizations?.wind_rose');
    
    if (simulationResult.data?.plotlyWindRose) {
      console.log('\n‚úÖ Orchestrator SHOULD pass through plotlyWindRose');
    } else {
      console.log('\n‚ùå Orchestrator will NOT have plotlyWindRose to pass through');
      console.log('   Problem is in simulation Lambda, not orchestrator');
    }
    
    // Step 4: Check frontend expectations
    console.log('\n\nStep 4: Frontend expectations...');
    console.log('WindRoseArtifact checks in this order:');
    console.log('   1. data.plotlyWindRose ‚Üí PlotlyWindRose component');
    console.log('   2. data.visualizationUrl ‚Üí PNG image');
    console.log('   3. data.windRoseData ‚Üí SVG fallback');
    
    if (simulationResult.data?.plotlyWindRose) {
      console.log('\n‚úÖ Frontend SHOULD render PlotlyWindRose component');
    } else if (simulationResult.data?.visualizations?.wind_rose) {
      console.log('\n‚ö†Ô∏è  Frontend will fall back to PNG image');
    } else if (simulationResult.data?.windRoseData) {
      console.log('\n‚ö†Ô∏è  Frontend will fall back to SVG');
    } else {
      console.log('\n‚ùå Frontend will show "No data available"');
    }
    
    // Summary
    console.log('\n\n' + '='.repeat(60));
    console.log('SUMMARY');
    console.log('='.repeat(60));
    
    if (simulationResult.data?.plotlyWindRose) {
      console.log('‚úÖ Plotly data IS being generated by backend');
      console.log('‚úÖ Orchestrator IS configured to pass it through');
      console.log('‚úÖ Frontend IS configured to render it');
      console.log('\nüéØ If Plotly is not showing, check:');
      console.log('   1. Browser console for errors');
      console.log('   2. Network tab for failed requests');
      console.log('   3. PlotlyWindRose component rendering');
    } else {
      console.log('‚ùå Plotly data is NOT being generated by backend');
      console.log('\nüîß Need to fix simulation Lambda:');
      console.log('   File: amplify/functions/renewableTools/simulation/handler.py');
      console.log('   Check: plotly_wind_rose_generator.py is being called');
      console.log('   Check: plotlyWindRose is in response');
    }
    
  } catch (error) {
    console.error('‚ùå Error calling simulation Lambda:', error.message);
    process.exit(1);
  }
}

debugWindRoseFlow().catch(console.error);
