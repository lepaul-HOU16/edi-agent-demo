'use client';

import React, { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import {
  Container,
  Header,
  SpaceBetween,
  Tabs,
  ProgressBar,
  Badge,
  Table,
  Box,
  ColumnLayout,
  KeyValuePairs,
  Alert,
  LineChart,
  BarChart,
  Button,
  Select,
  Toggle
} from '@cloudscape-design/components';
import Plot from 'react-plotly.js';
import dynamic from 'next/dynamic';

interface TurbinePosition {
  id: string;
  x: number;
  y: number;
  elevation: number;
  windSpeed: number;
  efficiency: number;
  status?: string;
}

interface SpacingAnalysis {
  averageSpacing: number;
  minimumSpacing: number;
  maximumSpacing: number;
  optimalSpacing: number;
  compliancePercentage: number;
}

interface CapacityCalculation {
  totalTurbines: number;
  turbineCapacity: number;
  totalCapacity: number;
  expectedAnnualOutput: number;
  capacityFactor: number;
}

interface WindFarmLayoutData {
  title?: string;
  subtitle?: string;
  targetCapacity?: string;
  turbineModel?: string;
  spacing?: string;
  coordinates?: {
    lat: number;
    lng: number;
  };
  layout?: {
    turbineCount?: string;
    spacing?: string;
    totalCapacity?: string;
    estimatedAEP?: string;
    turbinePositions?: TurbinePosition[];
  };
  siteId?: string;
  siteName?: string;
  turbinePositions?: TurbinePosition[];
  spacingAnalysis?: SpacingAnalysis;
  capacityCalculation?: CapacityCalculation;
  layoutEfficiency?: number;
  wakeAnalysis?: {
    totalWakeLoss: number;
    averageWakeLoss: number;
    criticalInteractions: number;
  };
  complianceStatus?: {
    setbackCompliance: boolean;
    spacingCompliance: boolean;
    environmentalCompliance: boolean;
  };
  optimizationMetrics?: {
    energyYieldOptimization: number;
    wakeMinimization: number;
    spatialEfficiency: number;
  };
}

interface WindFarmLayoutComponentProps {
  data: WindFarmLayoutData;
}

// Safe number validation and conversion utility
const safeNumber = (value: any, fallback: number): number => {
  if (typeof value === 'number' && !isNaN(value) && isFinite(value)) {
    return value;
  }
  if (typeof value === 'string') {
    const parsed = parseFloat(value);
    if (!isNaN(parsed) && isFinite(parsed)) {
      return parsed;
    }
  }
  return fallback;
};

// Safe coordinate validation
const validateCoordinates = (lat: any, lng: any): { lat: number; lng: number } => {
  const safeLat = safeNumber(lat, 32.7767);
  const safeLng = safeNumber(lng, -96.7970);
  
  // Validate coordinate ranges
  const validLat = Math.max(-90, Math.min(90, safeLat));
  const validLng = Math.max(-180, Math.min(180, safeLng));
  
  return { lat: validLat, lng: validLng };
};

// Mock data generators with stable seeding
const generateTurbinePositions = (count: number, centerLat: number, centerLng: number, seed: number = 42) => {
  const positions = [];
  const gridSize = Math.ceil(Math.sqrt(count));
  const spacing = 0.002;
  
  let seedValue = seed;
  const seededRandom = () => {
    seedValue = (seedValue * 9301 + 49297) % 233280;
    return seedValue / 233280;
  };
  
  for (let i = 0; i < count; i++) {
    const row = Math.floor(i / gridSize);
    const col = i % gridSize;
    positions.push({
      id: `T${String(i + 1).padStart(3, '0')}`,
      x: safeNumber(centerLng + (col - gridSize/2) * spacing, -96.7970),
      y: safeNumber(centerLat + (row - gridSize/2) * spacing, 32.7767),
      elevation: safeNumber(150 + seededRandom() * 50, 150),
      windSpeed: safeNumber(7.5 + seededRandom() * 2, 8),
      efficiency: safeNumber(75 + seededRandom() * 20, 80),
      status: seededRandom() > 0.1 ? 'operational' : 'maintenance'
    });
  }
  return positions;
};

const generateSpacingData = (turbineCount: number, seed: number = 42) => {
  const spacings = [];
  let seedValue = seed;
  const seededRandom = () => {
    seedValue = (seedValue * 9301 + 49297) % 233280;
    return seedValue / 233280;
  };
  
  for (let i = 0; i < turbineCount - 1; i++) {
    spacings.push({
      turbineA: `T${String(i + 1).padStart(3, '0')}`,
      turbineB: `T${String(i + 2).padStart(3, '0')}`,
      distance: safeNumber(250 + seededRandom() * 100, 300),
      direction: safeNumber(seededRandom() * 360, 180),
      compliant: seededRandom() > 0.2
    });
  }
  return spacings;
};

const generateWindRoseData = (seed: number = 42) => {
  const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
  let seedValue = seed;
  const seededRandom = () => {
    seedValue = (seedValue * 9301 + 49297) % 233280;
    return seedValue / 233280;
  };
  
  return directions.map(dir => ({
    direction: dir,
    frequency: safeNumber(seededRandom() * 20 + 5, 12),
    avgSpeed: safeNumber(seededRandom() * 5 + 8, 10)
  }));
};

const WindFarmLayoutComponent: React.FC<WindFarmLayoutComponentProps> = ({ data }) => {
  // UI State - Only controls what shows/hides in UI
  const [selectedView, setSelectedView] = useState('2d');
  const [showWindRose, setShowWindRose] = useState(true);
  const [showWakeAnalysis, setShowWakeAnalysis] = useState(false);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [mapError, setMapError] = useState<string | null>(null);
  const [isMapReady, setIsMapReady] = useState(false);
  
  // Dynamic import for MapLibre GL component to prevent SSR issues
  const WindFarmMapVisualization = dynamic(
    () => import('../WindFarmMapVisualization'),
    {
      ssr: false,
      loading: () => <div style={{ 
        height: '400px', 
        width: '100%', 
        border: '2px solid #e1e8ed',
        borderRadius: '8px',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: '#f5f5f5'
      }}>Loading interactive map...</div>
    }
  );
  
  // Check if we have the new simplified format or legacy detailed format
  const isSimplifiedFormat = !data.capacityCalculation && data.layout;
  
  // Validate and extract coordinates with proper error handling
  const safeCoordinates = useMemo(() => {
    try {
      return validateCoordinates(data.coordinates?.lat, data.coordinates?.lng);
    } catch (error) {
      console.warn('Invalid coordinates provided, using defaults:', error);
      return { lat: 32.7767, lng: -96.7970 };
    }
  }, [data.coordinates?.lat, data.coordinates?.lng]);
  
  // Generate turbine count with proper validation and clamping
  const turbineCount = useMemo(() => {
    try {
      const countStr = data.layout?.turbineCount?.toString() || '8';
      const numericOnly = countStr.replace(/[^\d]/g, '');
      const parsed = parseInt(numericOnly);
      const validated = !isNaN(parsed) && parsed > 0 ? parsed : 8;
      return Math.max(1, Math.min(validated, 50)); // Clamp between 1-50
    } catch (error) {
      console.warn('Invalid turbine count, using default:', error);
      return 8;
    }
  }, [data.layout?.turbineCount]);

  // Generate stable mock data using useMemo with consistent seed
  const mockTurbines = useMemo(() => {
    try {
      return generateTurbinePositions(turbineCount, safeCoordinates.lat, safeCoordinates.lng, 42);
    } catch (error) {
      console.warn('Error generating turbine positions:', error);
      return [];
    }
  }, [turbineCount, safeCoordinates.lat, safeCoordinates.lng]);

  const mockSpacingData = useMemo(() => {
    try {
      return generateSpacingData(turbineCount, 123);
    } catch (error) {
      console.warn('Error generating spacing data:', error);
      return [];
    }
  }, [turbineCount]);
  
  const windRoseData = useMemo(() => {
    try {
      return generateWindRoseData(456);
    } catch (error) {
      console.warn('Error generating wind rose data:', error);
      return [];
    }
  }, []);

  // Proper wind rose data for Plotly polar chart
  const windRoseChartData = useMemo(() => {
    try {
      // Convert wind directions to angles (meteorological convention: North = 0¬∞)
      const directionAngles = {
        'N': 0, 'NE': 45, 'E': 90, 'SE': 135, 
        'S': 180, 'SW': 225, 'W': 270, 'NW': 315
      };

      // Create data for wind rose with frequency as radius and speed as color
      const theta = windRoseData.map(item => directionAngles[item.direction] || 0);
      const r = windRoseData.map(item => safeNumber(item.frequency, 10));
      const windSpeeds = windRoseData.map(item => safeNumber(item.avgSpeed, 8));
      const hoverText = windRoseData.map((item, i) => 
        `Direction: ${item.direction}<br>` +
        `Frequency: ${r[i].toFixed(1)}%<br>` +
        `Avg Speed: ${windSpeeds[i].toFixed(1)} m/s`
      );

      return {
        theta,
        r,
        windSpeeds,
        hoverText,
        directions: windRoseData.map(item => item.direction)
      };
    } catch (error) {
      console.warn('Error generating wind rose data:', error);
      return {
        theta: [0, 45, 90, 135, 180, 225, 270, 315],
        r: [10, 12, 8, 15, 18, 10, 14, 11],
        windSpeeds: [8, 9, 7, 10, 11, 8, 9, 8],
        hoverText: ['N: 10%, 8 m/s', 'NE: 12%, 9 m/s', 'E: 8%, 7 m/s', 'SE: 15%, 10 m/s', 
                   'S: 18%, 11 m/s', 'SW: 10%, 8 m/s', 'W: 14%, 9 m/s', 'NW: 11%, 8 m/s'],
        directions: ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW']
      };
    }
  }, [windRoseData]);

  const barChartSeries = useMemo(() => {
    try {
      return [{
        title: "Average Wind Speed",
        type: "bar" as const,
        data: windRoseData.map(item => ({ 
          x: item.direction || 'N', 
          y: Math.max(0, Math.round(safeNumber(item.avgSpeed, 8) * 100) / 100)
        }))
      }];
    } catch (error) {
      console.warn('Error generating bar chart data:', error);
      return [{ title: "Wind Speed", type: "bar" as const, data: [{ x: 'N', y: 8 }] }];
    }
  }, [windRoseData]);

  const lineChartSeries = useMemo(() => {
    try {
      return [{
        title: "Turbine Efficiency (%)",
        type: "line" as const,
        data: mockTurbines.slice(0, 12).map((t, i) => ({ 
          x: i, 
          y: Math.max(0, Math.min(100, Math.round(safeNumber(t.efficiency, 80) * 100) / 100))
        }))
      }];
    } catch (error) {
      console.warn('Error generating line chart data:', error);
      return [{ title: "Efficiency", type: "line" as const, data: [{ x: 0, y: 80 }] }];
    }
  }, [mockTurbines]);

  // Safely extract turbine count from various data sources
  const actualTurbineCount = useMemo(() => {
    try {
      // Try multiple sources for turbine count
      if (data.turbinePositions?.length) {
        return data.turbinePositions.length;
      }
      if (data.layout?.turbinePositions?.length) {
        return data.layout.turbinePositions.length;
      }
      if (data.capacityCalculation?.totalTurbines) {
        return data.capacityCalculation.totalTurbines;
      }
      return turbineCount; // fallback to parsed count
    } catch (error) {
      console.warn('Error extracting turbine count:', error);
      return turbineCount;
    }
  }, [data, turbineCount]);

  // Safely extract capacity information
  const safeCapacity = useMemo(() => {
    try {
      const targetCap = data.targetCapacity;
      const layoutCap = data.layout?.totalCapacity;
      const calcCap = data.capacityCalculation?.totalCapacity;
      
      // Clean up capacity values
      if (targetCap && typeof targetCap === 'string' && !targetCap.includes('undefined')) {
        return targetCap;
      }
      if (layoutCap && typeof layoutCap === 'string' && !layoutCap.includes('undefined')) {
        return layoutCap;
      }
      if (calcCap && !isNaN(calcCap)) {
        return `${calcCap}MW`;
      }
      return '30MW'; // Default fallback
    } catch (error) {
      console.warn('Error extracting capacity:', error);
      return '30MW';
    }
  }, [data]);

  // Generate clean subtitle without undefined values
  const cleanSubtitle = useMemo(() => {
    try {
      const capacity = safeCapacity;
      const turbines = actualTurbineCount;
      return `${capacity} wind farm layout with ${turbines} turbines optimized for maximum efficiency`;
    } catch (error) {
      console.warn('Error generating subtitle:', error);
      return 'Interactive wind farm layout optimization and analysis';
    }
  }, [safeCapacity, actualTurbineCount]);

  // Handle both simplified and detailed data formats with safe access
  const layoutOverviewItems = useMemo(() => {
    try {
      if (isSimplifiedFormat) {
        return [
          { label: 'Site Location', value: `${safeCoordinates.lat.toFixed(4)}, ${safeCoordinates.lng.toFixed(4)}` },
          { label: 'Target Capacity', value: safeCapacity },
          { label: 'Turbine Model', value: data.turbineModel || 'IEA Reference 3.4MW' },
          { label: 'Turbine Count', value: actualTurbineCount.toString() },
          { label: 'Spacing', value: data.layout?.spacing || data.spacing || '9D x 3D' },
          { label: 'Total Capacity', value: safeCapacity },
          { label: 'Estimated AEP', value: data.layout?.estimatedAEP || 'TBD' }
        ];
      } else {
        return [
          { label: 'Site Name', value: data.siteName || 'Wind Farm Site' },
          { label: 'Total Turbines', value: actualTurbineCount.toString() },
          { label: 'Total Capacity', value: safeCapacity },
          { label: 'Layout Efficiency', value: data.layoutEfficiency ? `${safeNumber(data.layoutEfficiency, 85)}%` : '85%' },
          { label: 'Expected Annual Output', value: data.capacityCalculation?.expectedAnnualOutput ? `${safeNumber(data.capacityCalculation.expectedAnnualOutput, 100000).toLocaleString()} MWh` : '100,000 MWh' },
          { label: 'Capacity Factor', value: data.capacityCalculation?.capacityFactor ? `${safeNumber(data.capacityCalculation.capacityFactor, 35)}%` : '35%' }
        ];
      }
    } catch (error) {
      console.warn('Error generating layout overview items:', error);
      return [{ label: 'Status', value: 'Data Error' }];
    }
  }, [isSimplifiedFormat, safeCoordinates, actualTurbineCount, data, safeCapacity]);

  // View toggle handler
  const handleViewToggle = useCallback((view: string) => {
    if (view === selectedView) return;
    
    setIsTransitioning(true);
    setSelectedView(view);
    
    setTimeout(() => {
      setIsTransitioning(false);
    }, 1000);
  }, [selectedView]);

  // Map event handlers
  const handleMapReady = useCallback(() => {
    setIsMapReady(true);
  }, []);

  const handleMapError = useCallback((error: string) => {
    setMapError(error);
  }, []);

  // Interactive Layout Map Component - WITH WORKING CONTROLS
  const LayoutMapVisualization = () => (
    <Container>
      <Header 
        variant="h2"
        actions={
          <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
            <Toggle
              onChange={({ detail }) => {
                console.log('Wind Rose toggle:', detail.checked);
                setShowWindRose(detail.checked);
              }}
              checked={showWindRose}
            >
              Wind Rose {showWindRose && <Badge color="green">ON</Badge>}
            </Toggle>
            <Toggle
              onChange={({ detail }) => {
                console.log('Wake Analysis toggle:', detail.checked);
                setShowWakeAnalysis(detail.checked);
              }}
              checked={showWakeAnalysis}
            >
              Wake Analysis {showWakeAnalysis && <Badge color="green">ON</Badge>}
            </Toggle>
            <Select
              selectedOption={{ label: selectedView.toUpperCase(), value: selectedView }}
              onChange={({ detail }) => {
                if (detail.selectedOption) {
                  handleViewToggle(detail.selectedOption.value);
                }
              }}
              options={[
                { label: '2D', value: '2d' },
                { label: '3D', value: '3d' }
              ]}
              ariaLabel="View mode"
            />
          </div>
        }
      >
        Interactive Wind Farm Layout ({selectedView.toUpperCase()})
        {selectedView === '3d' && <Badge color="blue">3D Mode</Badge>}
        {isTransitioning && <Badge color="grey">Transitioning...</Badge>}
      </Header>
      
      <Box margin={{ top: 'l' }}>
        {mapError ? (
          <Alert
            statusIconAriaLabel="Error"
            type="error"
            header="Map Loading Error"
          >
            {mapError} - Please try refreshing the page.
          </Alert>
        ) : (
          <WindFarmMapVisualization
            turbineData={mockTurbines}
            coordinates={safeCoordinates}
            selectedView={selectedView as '2d' | '3d'}
            isTransitioning={isTransitioning}
            onMapReady={handleMapReady}
            onMapError={handleMapError}
          />
        )}
        
        {isTransitioning && (
          <div
            style={{
              position: 'absolute',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              backgroundColor: '#ffffff',
              borderRadius: '8px',
              boxShadow: '0 2px 6px rgba(0, 0, 0, 0.15)',
              padding: '16px',
              textAlign: 'center',
              zIndex: 1000
            }}
          >
            <Badge color="blue">
              Transitioning to {selectedView.toUpperCase()} view...
            </Badge>
          </div>
        )}
      </Box>
      
      <Alert
        statusIconAriaLabel="Info"
        header="Wind Farm Site Details"
      >
        <ColumnLayout columns={2} variant="text-grid">
          <div>
            <Box variant="strong">üìç Location</Box>
            <Box variant="span">{safeCoordinates.lat.toFixed(4)}, {safeCoordinates.lng.toFixed(4)}</Box>
          </div>
          <div>
            <Box variant="strong">üå™Ô∏è Turbines</Box>
            <Box variant="span">{turbineCount} units</Box>
          </div>
          <div>
            <Box variant="strong">üìè Spacing</Box>
            <Box variant="span">{data.layout?.spacing || '9D x 3D'}</Box>
          </div>
          <div>
            <Box variant="strong">‚ö° Capacity</Box>
            <Box variant="span">{data.layout?.totalCapacity || data.targetCapacity}</Box>
          </div>
        </ColumnLayout>
      </Alert>
    </Container>
  );

  const tabs = [
    {
      label: 'Layout Overview',
      id: 'overview',
      content: (
        <SpaceBetween direction="vertical" size="l">
          <LayoutMapVisualization />
          
          <Container>
            <KeyValuePairs columns={2} items={layoutOverviewItems} />
          </Container>

          <ColumnLayout columns={3} variant="text-grid">
            <div>
              <Box variant="h3">Layout Efficiency</Box>
              <ProgressBar
                value={85}
                additionalInfo="85%"
                description="Optimized turbine placement efficiency"
              />
            </div>
            <div>
              <Box variant="h3">Wake Loss Minimization</Box>
              <ProgressBar
                value={92}
                additionalInfo="8% total wake loss"
                description="Reduced wake interference"
              />
            </div>
            <div>
              <Box variant="h3">Site Utilization</Box>
              <ProgressBar
                value={78}
                additionalInfo="78% of buildable area"
                description="Efficient land use"
              />
            </div>
          </ColumnLayout>

          {showWindRose && (
            <Container>
              <Header variant="h2">
                Wind Resource Analysis  
                <Badge color="green">Wind Rose Active</Badge>
              </Header>
              <Box margin={{ top: 'm', bottom: 'm' }}>
                <Alert
                  statusIconAriaLabel="Success"
                  type="success"
                  header="Wind Rose Analysis Enabled"
                >
                  Displaying wind direction frequency and speed analysis. The visualization shows the predominant wind patterns for optimal turbine orientation.
                </Alert>
              </Box>
              <ColumnLayout columns={2}>
                <div>
                  <Box variant="h3" margin={{ bottom: 's' }}>Wind Rose</Box>
                  <Plot
                    data={[
                      {
                        type: 'scatterpolar',
                        r: windRoseChartData.r,
                        theta: windRoseChartData.theta,
                        fill: 'toself',
                        fillcolor: 'rgba(0, 115, 187, 0.5)',
                        line: { color: '#0073bb', width: 2 },
                        marker: { 
                          size: 8, 
                          color: windRoseChartData.windSpeeds,
                          colorscale: [
                            [0, '#4ade80'],      // Green for low speeds
                            [0.5, '#facc15'],    // Yellow for medium speeds  
                            [1, '#f87171']       // Red for high speeds
                          ],
                          showscale: true,
                          colorbar: {
                            title: 'Wind Speed (m/s)',
                            titleside: 'right',
                            thickness: 15,
                            len: 0.7
                          }
                        },
                        hovertext: windRoseChartData.hoverText,
                        hoverinfo: 'text',
                        name: 'Wind Rose'
                      }
                    ]}
                    layout={{
                      polar: {
                        radialaxis: {
                          visible: true,
                          range: [0, Math.max(...windRoseChartData.r) * 1.1],
                          title: 'Frequency (%)',
                          titlefont: { size: 12 }
                        },
                        angularaxis: {
                          tickmode: 'array',
                          tickvals: [0, 45, 90, 135, 180, 225, 270, 315],
                          ticktext: ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'],
                          direction: 'clockwise',
                          rotation: 90
                        }
                      },
                      showlegend: false,
                      margin: { t: 50, b: 50, l: 50, r: 80 },
                      height: 400,
                      font: { size: 11 },
                      paper_bgcolor: 'rgba(0,0,0,0)',
                      plot_bgcolor: 'rgba(0,0,0,0)'
                    }}
                    config={{ 
                      displayModeBar: false,
                      staticPlot: false,
                      responsive: true
                    }}
                    style={{ width: '100%', height: '400px' }}
                  />
                </div>
                <div>
                  <Box variant="h3" margin={{ bottom: 's' }}>Wind Speed Distribution</Box>
                  <BarChart
                    series={barChartSeries}
                    xDomain={windRoseData.map(item => item.direction)}
                    yDomain={[0, 15]}
                    i18nStrings={{
                      legendAriaLabel: "Legend",
                      chartAriaRoleDescription: "Bar chart showing average wind speeds by direction",
                      xTickFormatter: (value) => value.toString(),
                      yTickFormatter: (value) => `${value} m/s`
                    }}
                    ariaLabel="Wind speed by direction"
                    height={200}
                  />
                  <Box margin={{ top: 's' }}>
                    <Alert
                      statusIconAriaLabel="Info"
                      type="info"
                      header="Wind Analysis Summary"
                    >
                      <ul style={{ margin: 0, paddingLeft: '20px' }}>
                        <li><strong>Prevailing Wind:</strong> {(() => {
                          const prevailingWind = windRoseData.length > 0 
                            ? windRoseData.reduce((prev, current) => 
                                (prev.frequency > current.frequency) ? prev : current, windRoseData[0])
                            : { direction: 'N', avgSpeed: 8.0 };
                          return `${prevailingWind.direction} at ${prevailingWind.avgSpeed?.toFixed(1) || '8.0'} m/s`;
                        })()}
                        </li>
                        <li><strong>Optimal Turbine Orientation:</strong> Perpendicular to prevailing wind</li>
                        <li><strong>Wind Resource Quality:</strong> Excellent for energy generation</li>
                      </ul>
                    </Alert>
                  </Box>
                </div>
              </ColumnLayout>
            </Container>
          )}

          {showWakeAnalysis && (
            <Container>
              <Header variant="h2">
                Wake Analysis  
                <Badge color="green">Wake Analysis Active</Badge>
              </Header>
              <Box margin={{ top: 'm', bottom: 'm' }}>
                <Alert
                  statusIconAriaLabel="Success"
                  type="success"
                  header="Wake Analysis Enabled"
                >
                  Showing detailed wake interaction analysis between turbines. This helps optimize energy production by minimizing wake losses.
                </Alert>
              </Box>
              <ColumnLayout columns={2}>
                <div>
                  <Alert
                    statusIconAriaLabel="Info"
                    header="Wake Effect Analysis"
                  >
                    <ColumnLayout columns={3} variant="text-grid">
                      <div>
                        <Box variant="strong">Total Wake Loss</Box>
                        <Box variant="span">8.2%</Box>
                      </div>
                      <div>
                        <Box variant="strong">Average Wake Loss</Box>
                        <Box variant="span">4.1%</Box>
                      </div>
                      <div>
                        <Box variant="strong">Critical Interactions</Box>
                        <Box variant="span">3 turbine pairs</Box>
                      </div>
                    </ColumnLayout>
                  </Alert>
                </div>
                <div>
                  <LineChart
                    series={[{
                      title: "Wake Loss %",
                      type: "line" as const,
                      data: mockTurbines.slice(0, 12).map((t, i) => ({ 
                        x: i, 
                        y: Math.max(0, Math.min(20, Math.round((100 - safeNumber(t.efficiency, 80)) * 0.5 * 100) / 100))
                      }))
                    }]}
                    xDomain={mockTurbines.slice(0, 12).map((_, i) => i)}
                    yDomain={[0, 20]}
                    i18nStrings={{
                      legendAriaLabel: "Legend",
                      chartAriaRoleDescription: "Line chart showing wake losses",
                      xTickFormatter: (value) => `T${Number(value)+1}`,
                      yTickFormatter: (value) => `${value}%`
                    }}
                    ariaLabel="Wake loss by turbine"
                    height={200}
                  />
                </div>
              </ColumnLayout>
              <Box margin={{ top: 's' }}>
                <p>Wake analysis shows minimal interference between turbines due to optimized spacing and prevailing wind direction alignment. The layout maintains high efficiency across the entire wind farm.</p>
              </Box>
            </Container>
          )}

          {isSimplifiedFormat && (
            <Alert
              statusIconAriaLabel="Info"
              header="Wind Farm Layout Visualization"
            >
              The interactive map above shows the preliminary wind farm layout with turbine positions. 
              Each turbine marker can be clicked for detailed information about efficiency, wind speed, and operational status.
            </Alert>
          )}
        </SpaceBetween>
      )
    },
    {
      label: 'Turbine Positions',
      id: 'positions',
      content: (
        <SpaceBetween direction="vertical" size="l">
          <Container>
            <Header 
              variant="h2"
              actions={
                <Button variant="primary" iconName="download">
                  Export Coordinates
                </Button>
              }
            >
              Turbine Position Analysis
            </Header>
            
            <ColumnLayout columns={2}>
              <div>
                <LineChart
                  series={lineChartSeries}
                  xDomain={mockTurbines.slice(0, 12).map((_, i) => i)}
                  yDomain={[60, 100]}
                  i18nStrings={{
                    legendAriaLabel: "Legend",
                    chartAriaRoleDescription: "Line chart showing turbine efficiency",
                    xTickFormatter: (value) => `T${Number(value)+1}`,
                    yTickFormatter: (value) => `${value}%`
                  }}
                  ariaLabel="Turbine efficiency chart"
                  height={250}
                />
              </div>
              <div>
                <BarChart
                  series={[{
                    title: "Wind Speed (m/s)",
                    type: "bar" as const,
                    data: mockTurbines.slice(0, 12).map((t, i) => ({ 
                      x: i, 
                      y: Math.max(0, Math.round(safeNumber(t.windSpeed, 8) * 100) / 100)
                    }))
                  }]}
                  xDomain={mockTurbines.slice(0, 12).map((_, i) => i)}
                  yDomain={[0, 12]}
                  i18nStrings={{
                    legendAriaLabel: "Legend",
                    chartAriaRoleDescription: "Bar chart showing wind speeds by turbine",
                    xTickFormatter: (value) => `T${Number(value)+1}`,
                    yTickFormatter: (value) => `${value} m/s`
                  }}
                  ariaLabel="Wind speed by turbine"
                  height={250}
                />
              </div>
            </ColumnLayout>
          </Container>
          
          <Container>
            <Table
              columnDefinitions={[
                {
                  id: 'id',
                  header: 'Turbine ID',
                  cell: (item: TurbinePosition) => item.id || 'N/A',
                  sortingField: 'id'
                },
                {
                  id: 'coordinates',
                  header: 'Coordinates',
                  cell: (item: TurbinePosition) => `${safeNumber(item.y, 0).toFixed(4)}, ${safeNumber(item.x, 0).toFixed(4)}`
                },
                {
                  id: 'elevation',
                  header: 'Elevation (m)',
                  cell: (item: TurbinePosition) => safeNumber(item.elevation, 0).toFixed(1)
                },
                {
                  id: 'windSpeed',
                  header: 'Wind Speed (m/s)',
                  cell: (item: TurbinePosition) => safeNumber(item.windSpeed, 0).toFixed(1)
                },
                {
                  id: 'efficiency',
                  header: 'Efficiency (%)',
                  cell: (item: TurbinePosition) => safeNumber(item.efficiency, 0).toFixed(1)
                },
                {
                  id: 'status',
                  header: 'Status',
                  cell: (item: TurbinePosition) => (
                    <Badge color={item.status === 'operational' ? 'green' : 'grey'}>
                      {item.status || 'operational'}
                    </Badge>
                  )
                }
              ]}
              items={mockTurbines}
              loadingText="Loading turbine positions..."
              sortingDisabled={false}
              variant="borderless"
              stickyHeader
              header={
                <Header
                  counter={`(${mockTurbines.length})`}
                  description="Detailed position data for all turbines"
                >
                  Turbine Position Data
                </Header>
              }
            />
          </Container>
        </SpaceBetween>
      )
    },
    {
      label: 'Spacing Analysis',
      id: 'spacing',
      content: (
        <SpaceBetween direction="vertical" size="l">
          <Container>
            <Header variant="h2">Turbine Spacing Compliance</Header>
            <ColumnLayout columns={4} variant="text-grid">
              <div>
                <Box variant="strong">Average Spacing</Box>
                <Box variant="span">
                  {mockSpacingData.length > 0 
                    ? `${(mockSpacingData.reduce((sum, item) => sum + safeNumber(item.distance, 300), 0) / mockSpacingData.length).toFixed(0)}m`
                    : '300m'
                  }
                </Box>
              </div>
              <div>
                <Box variant="strong">Minimum Spacing</Box>
                <Box variant="span">
                  {mockSpacingData.length > 0
                    ? `${Math.min(...mockSpacingData.map(item => safeNumber(item.distance, 300))).toFixed(0)}m`
                    : '250m'
                  }
                </Box>
              </div>
              <div>
                <Box variant="strong">Maximum Spacing</Box>
                <Box variant="span">
                  {mockSpacingData.length > 0
                    ? `${Math.max(...mockSpacingData.map(item => safeNumber(item.distance, 300))).toFixed(0)}m`
                    : '350m'
                  }
                </Box>
              </div>
              <div>
                <Box variant="strong">Compliance Rate</Box>
                <Box variant="span">
                  {mockSpacingData.length > 0
                    ? `${Math.round((mockSpacingData.filter(item => item.compliant).length / mockSpacingData.length) * 100)}%`
                    : '95%'
                  }
                </Box>
              </div>
            </ColumnLayout>
          </Container>
          
          <Container>
            <Table
              columnDefinitions={[
                {
                  id: 'turbineA',
                  header: 'From Turbine',
                  cell: (item: any) => item.turbineA || 'T001',
                  sortingField: 'turbineA'
                },
                {
                  id: 'turbineB',
                  header: 'To Turbine',
                  cell: (item: any) => item.turbineB || 'T002',
                  sortingField: 'turbineB'
                },
                {
                  id: 'distance',
                  header: 'Distance (m)',
                  cell: (item: any) => safeNumber(item.distance, 300).toFixed(1),
                  sortingField: 'distance'
                },
                {
                  id: 'direction',
                  header: 'Direction (¬∞)',
                  cell: (item: any) => safeNumber(item.direction, 180).toFixed(1)
                },
                {
                  id: 'compliant',
                  header: 'Compliant',
                  cell: (item: any) => (
                    <Badge color={item.compliant ? 'green' : 'red'}>
                      {item.compliant ? 'Yes' : 'No'}
                    </Badge>
                  )
                }
              ]}
              items={mockSpacingData}
              loadingText="Loading spacing analysis..."
              sortingDisabled={false}
              variant="borderless"
              stickyHeader
              header={
                <Header
                  counter={`(${mockSpacingData.length})`}
                  description="Inter-turbine spacing measurements and compliance status"
                >
                  Spacing Measurements
                </Header>
              }
            />
          </Container>

          <Alert
            statusIconAriaLabel="Info"
            header="Spacing Requirements"
          >
            <p>
              Turbine spacing requirements are typically 3-5 rotor diameters (3D-5D) in the cross-wind direction 
              and 7-10 rotor diameters (7D-10D) in the prevailing wind direction to minimize wake effects 
              and maximize energy production.
            </p>
          </Alert>
        </SpaceBetween>
      )
    }
  ];

  return (
    <Container>
      <Header
        variant="h1"
        description={cleanSubtitle}
      >
        {data.title || 'Wind Farm Layout Analysis'}
      </Header>

      <Tabs
        tabs={tabs}
        ariaLabel="Wind farm layout analysis tabs"
      />
    </Container>
  );
};

export default WindFarmLayoutComponent;
